"use strict";var Game=function(){this.grid=[4,4],this.gridZone={a1:{digit:0,isAbleMarge:!0},a2:{digit:0,isAbleMarge:!0},a3:{digit:0,isAbleMarge:!0},a4:{digit:0,isAbleMarge:!0},b1:{digit:0,isAbleMarge:!0},b2:{digit:0,isAbleMarge:!0},b3:{digit:0,isAbleMarge:!0},b4:{digit:0,isAbleMarge:!0},c1:{digit:0,isAbleMarge:!0},c2:{digit:0,isAbleMarge:!0},c3:{digit:0,isAbleMarge:!0},c4:{digit:0,isAbleMarge:!0},d1:{digit:0,isAbleMarge:!0},d2:{digit:0,isAbleMarge:!0},d3:{digit:0,isAbleMarge:!0},d4:{digit:0,isAbleMarge:!0}},this.gridZoneKeys=_.keys(this.gridZone),this.moved=!1,this.score=0,this.winValue=2048,this.changing=!1};Game.prototype.generateGrid=function(){for(var a=this,b="",c=0;c<a.grid[0];c++)b+=new Array(a.grid[1]+1).join('<div class="puzzle--game--node"></div>');$(".puzzle--game").prepend(b)},Game.prototype.start=function(){this.resetKeyValues(),this.generateGrid(),this.generateNblock(),this.watchKeyboard()},Game.prototype.resetKeyValues=function(){this.blockKey={left:!1,right:!1,top:!1,bottom:!1}},Game.prototype.checkGameOver=function(){this.blockKey.left===!0&&this.blockKey.right===!0&&this.blockKey.top===!0&&this.blockKey.bottom===!0&&$(".puzzle--game--note").removeClass("is-hidden")},Game.prototype.checkWin=function(){var a=this;_.each(a.gridZone,function(b,c){a.gridZone[c].digit===a.winValue&&$(".puzzle--game--note").removeClass("is-hidden").html("Congratulation! You won :) <br> <small>Reload the browser to play again!</small>")})},Game.prototype.generateNblock=function(a){var b=this;a="undefined"!=typeof a?a:2;for(var c=_.sample(this.gridZoneKeys,a),d="",e=0;a>e;e++){var f=2;d+='<div class="puzzle--game--tiles--item '+c[e]+" is-"+f+'">'+f+"</div>",b.gridZone[c[e]].digit=f}$(".puzzle--game--tiles").append(d)},Game.prototype.watchKeyboard=function(){var a=this;$("html").keydown(function(b){switch(b.which>=38&&b.which<=40&&b.preventDefault(),b.which){case 39:a.keyHandler("right");break;case 37:a.keyHandler("left");break;case 38:a.keyHandler("top");break;case 40:a.keyHandler("bottom")}})},Game.prototype.keysHasValue=function(){var a=_.mapObject(this.gridZone,function(a){return a.digit>0}),b=[];return _.mapObject(a,function(a,c){a===!0&&b.push(c)}),b},Game.prototype.keysHasNotValue=function(){var a=_.mapObject(this.gridZone,function(a){return a.digit>0}),b=[];return _.mapObject(a,function(a,c){a===!1&&b.push(c)}),b},Game.prototype.getGridKeysByColumn=function(){var a=_.groupBy(this.gridZoneKeys,function(a,b){return Math.floor(b/4)});return a},Game.prototype.getGridKeysByRow=function(){for(var a={},b=this.getGridKeysByColumn(),c=0;4>c;c++)a[c]=[b[0][c],b[1][c],b[2][c],b[3][c]];return a},Game.prototype.keyHandler=function(a){var b=this;if(b.changing!==!0){b.changing=!0;var c,d=this.keysHasValue(),e=!1;"top"===a||"bottom"===a?c=this.getGridKeysByColumn():("left"===a||"right"===a)&&(c=this.getGridKeysByRow()),"left"===a||"top"===a?_.each(c,function(a,b){c[b].reverse()}):("right"===a||"bottom"===a)&&d.reverse(),_.each(d,function(a){var d=a,f=b.gridZone[a].digit,g=!1;_.each(c,function(c){g=!1;var h=_.indexOf(c,a);if(-1!==h)for(var i=h;4>i;i++)if(i>h)if(0===b.gridZone[c[i]].digit)d=c[i],e=!0;else{if(b.gridZone[c[i]].digit!==b.gridZone[a].digit)return;b.gridZone[c[i]].digit===b.gridZone[a].digit&&b.gridZone[c[i]].isAbleMarge===!0&&(d=c[i],f+=f,g=!0,e=!0,f>0&&b.updateScore(f))}g===!0&&(b.gridZone[a].digit=0,b.gridZone[d].isAbleMarge=!1)}),b.change({old:{tile:a,val:0},"new":{tile:d,val:f}})}),b.resetMergeValue(),b.moved===!0?b.generateNewTile():b.blockKey[a]=!0,b.checkGameOver(),b.checkWin(),b.changing=!1}},Game.prototype.resetMergeValue=function(){var a=this;_.each(a.gridZone,function(b,c){a.gridZone[c].isAbleMarge=!0})},Game.prototype.change=function(a){var b=this;a.old.tile!==a["new"].tile&&($(".puzzle--game--tiles--item."+a["new"].tile).length>0&&$(".puzzle--game--tiles--item."+a["new"].tile).remove(),$(".puzzle--game--tiles--item."+a.old.tile).removeClass(a.old.tile).addClass(a["new"].tile).addClass("is-"+a["new"].val).html(a["new"].val),b.gridZone[a.old.tile].digit=a.old.val,b.gridZone[a["new"].tile].digit=a["new"].val,b.moved=!0)},Game.prototype.generateNewTile=function(){var a=this,b=_.sample(a.keysHasNotValue()),c=2;setTimeout(function(){$(".puzzle--game--tiles").append('<div class="puzzle--game--tiles--item '+b+" is-"+c+'">'+c+"</div>")},250),a.gridZone[b].digit=c,a.moved=!1,a.resetKeyValues()},Game.prototype.updateScore=function(a){var b=this;b.score+=a,$(".score--total--text").html(b.score)},jQuery(document).ready(function(){var a=new Game;a.start()}),jQuery(document).ready(function(a){a("html").addClass("js")});